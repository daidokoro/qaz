# Encypted Template Example

This example shows the structure of an encrypted template deployment.

__config.yml:__

```yaml

region: eu-west-1

project: encrypted

stacks:
  vpc:
    cf:
      cidr: 10.10.10.0/24
      cipher: |
        AQECAHiRNqIipUDpE+4nWEQGRLKB9ci5sQlpanWth9zQlQi4NQAAASQwggEgBgkqhkiG9w0BBwagggERMIIBDQIBADCCAQYGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMlFcCZUM1IiCidbDDAgEQgIHYj8EJNqPYSdGv5ZN7hlG+xu2ohckp8QOveOem3vosdn/hfJrBy1nGD+O2u0nZoKIJNkr4ko8Az5CwHATjviul2Zoy3IdT+KDl1fFGvuV4gAnAXH0wEqT5Y0ehhqrdSrDGSJVCxXTkWjq+L/jrXwR6xlT5gG7FX3tUDXGCIpRh7KcNdioDD4y7+7rI2TtfOdNgL1gA6iF8jwNLTNHdEYx+vE4qekZkbtpopPdSmJSdAIwqFoIAHcVziZNJ6tL0D0t4ctbSRereLXcF0gygU2kyWFTFLfLPFnkp


```
The Qaz config file has a single stack defined with two values. The First is a simple _cidr_ for the VPC and the second is a Cipher Text Blob generated by encrypting the entire VPC template using an AWS KMS key.



__template/vpc.yml:__

```yaml
{{ kms_decrypt .vpc.cipher }}

```

The `vpc.yml` stack template file only has a single line which calls the `kms_decrypt` Gen-Time function with the Cipher Text Blob.


--

Running `qaz generate vpc` will return.

```yaml
Resources:
  VPC:
    Type: "AWS::EC2::VPC"
    Properties:
      CidrBlock: << .vpc.cidr >>

Outputs:
  vpcid:
    Description: VPCID
    Value: !Ref VPC
    Export:
      Name: enc-vpc-id

```

__NOTE:__ This will only work for me, the Cipher Text Blob being used is linked to my AWS Account. You can encrypt your own values via KMS and switch the `.vpc.cipher` key in config to run tests. 

If you do not adjust `.vpc.cipher` you'll see:
```
ERROR AccessDeniedException: The ciphertext refers to a customer master key that does not exist, does not exist in this region, or you are not allowed to access.
status code: 400, request id: 03654822-09d6-11e7-8beb-91d09effe97e request=generate
```



In the above a Deploy-Time `<< .vpc.cidr >>` resolver is used to populate the values from config to the template after the Gen-Time function decrypts it. With this, what we have is a fully encrypted template being decrypted and dynamically populated upon deployment to AWS.


This can be stored here in Github without worry as any attempts to deploy this outside of the AWS Acount the Cipher belongs to result in the following:

```
ERROR AccessDeniedException: The ciphertext refers to a customer master key that does not exist, does not exist in this region, or you are not allowed to access.
status code: 400, request id: 03654822-09d6-11e7-8beb-91d09effe97e request=generate
```

--

# Important

There is a __4Kb__ size limit on strings that can be Encrypted using this method, as such it's not recommended to try to use this method for large stacks but rather on more sensitive bits of data.
